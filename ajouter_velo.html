<meta charset="utf-8"/>
<title>Ajouter un vélo</title>
<style>
    body {
        font: .8em "typewriter", sans-serif;
    }

    label {
        width: 100px;
        display: inline-block;
    }

    fieldset {
        width: 400px;
    }
</style>

<h1>Ajouter un vélo</h1>
<label>Nom</label>
<input type="text" id="bike-name" placeholder="Nom">
<br/>
<label>Catégorie</label>
<select id="bike-category"></select>
<button id="" onclick="showAddCategory()">+</button>
<span id="add-category-span" style="visibility:hidden">
  <input type="text" id="add-category-name">
  <button id="" onclick="addCategory()">Ajouter</button>
</span>
<br/>
<label>Prix</label>
<input type="text" id="bike-price" placeholder="Prix">
<br/>
<fieldset>
    <legend>Options</legend>
    <div id="option-div">
      <span>
        <input type="text" placeholder="Nom"><input type="text" placeholder="Prix"><button onclick="deleteOption(this)">-</button>
      </span>
    </div>
    <button id="" onclick="addOption()">Ajouter une option</button>
</fieldset>
<br/>
<button id="" onclick="addBike()">Enregistrer</button>

<script>
    const $ = document.getElementById.bind(document);

    refreshSelect();

    function showAddCategory() {
        $("add-category-span").style.visibility = "visible";
    }

    function hideAddCategory() {
        $("add-category-span").style.visibility = "hidden";
    }

    function addCategory() {
        const categoryName = $("add-category-name").value;
        $("bike-category").add(new Option(categoryName));
        saveCategory(categoryName);
        refreshSelect();
        hideAddCategory();
    }

    function saveCategory(category) {
        const categoriesJSON = window.localStorage.getItem("categories");
        const categories = JSON.parse(categoriesJSON) || [];
        console.log(categories);
        categories.push(category);
        window.localStorage.setItem("categories", JSON.stringify(categories));
    }

    function refreshSelect() {
        const categoriesJSON = window.localStorage.getItem("categories");
        const categories = JSON.parse(categoriesJSON) || [];
        categories.sort();
        const selectCategories = $("bike-category");
        categories.forEach(category => selectCategories.add(new Option(category)));
    }

    function addOption() {
        const option = `<span>
                           <input type="text" placeholder="Nom">
                           <input type="text" placeholder="Prix">
                           <button onclick="deleteOption(this)">-</button>
                         </span>`;
        $("option-div").insertAdjacentHTML('afterend', option);
    }

    function deleteOption(node) {
        node.parentNode.remove();
    }

    function addBike() {

        function getCurrentOptions() {
            //Convert HTMLCollection to Array
            const optionsNode = [...$("option-div").children];
            //Convert nodes into objects
            return optionsNode.map(optionNode => {
                return {
                    "name": optionNode.getElementsByTagName("input")[0].value,
                    "price": optionNode.getElementsByTagName("input")[1].value,
                }
            });
        }

        const bike = {
            "name": $("bike-name").value,
            "price": $("bike-price").value,
            "category": $("bike-category").value,
            "options": getCurrentOptions(),
        };

        saveBike(bike);
    }

    function saveBike(bike) {
        console.log("saving...");
        console.log(bike);
        const bikesJSON = window.localStorage.getItem("bikes");
        const bikes = JSON.parse(bikesJSON) || [];
        bikes.push(bike);
        const newBikesJSON = JSON.stringify(bikes);
        window.localStorage.setItem("bikes", newBikesJSON);
    }

</script>
